{% extends "dashboard.base.html" %}
{% block content %}
<div class="container mt-5">
    <h3>Novo item RSC</h3>
    <hr />
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-row">
            <div class="form-group col-md-2">
                <label for="id_numero" class="form-label"><b>Nº*</b></label>
                {{ form.numero }}
                {% if form.numero.errors %}
                <div class="invalid-feedback d-block">{{ form.numero.errors|join:", " }}</div>
                {% endif %}
            </div>
            <div class="form-group col-md-10">
                <label for="id_saberes_competencias" class="form-label"><b>Saberes e Competências*</b></label>
                {{ form.saberes_competencias }}
                {% if form.saberes_competencias.errors %}
                <div class="invalid-feedback d-block">{{ form.saberes_competencias.errors|join:", " }}</div>
                {% endif %}
            </div>
        </div>

        <div class="form-group">
            <label for="id_descricao_item" class="form-label">Descrição do item</label>
            {{ form.descricao_item }}
            {% if form.descricao_item.errors %}
            <div class="invalid-feedback d-block">{{ form.descricao_item.errors|join:", " }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_documentos_comprobatorios" class="form-label">Documentos comprobatórios</label>
            {{ form.documentos_comprobatorios }}
            {% if form.documentos_comprobatorios.errors %}
            <div class="invalid-feedback d-block">{{ form.documentos_comprobatorios.errors|join:", " }}</div>
            {% endif %}
        </div>
        <hr />
        <div class="form-row">
            <div class="form-group col-md-4">
                <label for="id_unidade_medida" class="form-label">Unidade de Medida</label>
                {{ form.unidade_medida }}
                {% if form.unidade_medida.errors %}
                <div class="invalid-feedback d-block">{{ form.unidade_medida.errors|join:", " }}</div>
                {% endif %}
            </div>
            <div class="form-group col-md-4">
                <label for="id_pontuacao" class="form-label">Pontuação</label>
                {{ form.pontuacao }}
                {% if form.pontuacao.errors %}
                <div class="invalid-feedback d-block">{{ form.pontuacao.errors|join:", " }}</div>
                {% endif %}
            </div>
            <div class="form-group col-md-4">
                <label class="form-label">Declarações</label>
                <div id="arquivos-wrapper">
                    <div class="arquivo-row d-flex align-items-start mb-2" data-initial="true">
                        <input type="file" name="arquivos" class="form-control form-control-sm" style="padding: 7px;" />
                        <button type="button" id="add-arquivo" class="btn mx-1" title="Adicionar outro">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <small class="form-text text-muted">Use o botão + para adicionar vários arquivos</small>
            </div>
        </div>
        <hr />
        <div class="form-row">
            <div class="form-group col-md-8">
                <label for="id_pessoas" class="form-label">Pessoas</label>
                {{ form.pessoas }}
                <small class="form-text text-muted">Separe os nomes por vírgula.</small>
                {% if form.pessoas.errors %}
                <div class="invalid-feedback d-block">{{ form.pessoas.errors|join:", " }}</div>
                {% endif %}
            </div>
            <div class="form-group col-md-4 d-flex align-items-center">
                <div class="form-check">
                    {{ form.solicitar_documentacao_chefia }}
                    <label class="form-check-label" for="id_solicitar_documentacao_chefia">Solicitar documentação a
                        chefia</label>
                </div>
                {% if form.solicitar_documentacao_chefia.errors %}
                <div class="invalid-feedback d-block">{{ form.solicitar_documentacao_chefia.errors|join:", " }}</div>
                {% endif %}
            </div>
        </div>

        <div class="form-group">
            <label for="id_observacoes" class="form-label">Observações</label>
            {{ form.observacoes }}
            {% if form.observacoes.errors %}
            <div class="invalid-feedback d-block">{{ form.observacoes.errors|join:", " }}</div>
            {% endif %}
        </div>
        <div class="form-group d-flex justify-content-end">
            <a href="{% url 'registro' %}" class="btn btn-secondary mr-2">Voltar</a>
            <button id="create-material" type="submit" class="btn btn-primary">
                Salvar <i class="fa-solid fa-floppy-disk"></i>
            </button>
        </div>
    </form>
    <script>
        // Comportamento dinâmico para múltiplos arquivos (estilo simplificado)
        (function () {
            const wrapper = document.getElementById('arquivos-wrapper');
            const addBtn = document.getElementById('add-arquivo');

            function createRow() {
                const row = document.createElement('div');
                row.className = 'arquivo-row d-flex align-items-start mb-2';
                row.innerHTML = `
                <input type="file" name="arquivos" class="form-control form-control-sm me-2" style="padding: 7px;"/>
                <button type="button" class="btn ml-1 remove-arquivo" title="Remover">
                    <i class="fas fa-trash"></i>
                </button>`;
                return row;
            }

            function updateVisibility() {
                const rows = wrapper.querySelectorAll('.arquivo-row');
                rows.forEach(r => {
                    const rm = r.querySelector('.remove-arquivo');
                    if (rm) rm.style.display = rows.length > 1 ? 'inline-block' : 'none';
                });
            }

            addBtn.addEventListener('click', function () {
                const row = createRow();
                wrapper.appendChild(row);
                updateVisibility();
            });

            wrapper.addEventListener('click', function (e) {
                if (e.target.closest && e.target.closest('.remove-arquivo')) {
                    const row = e.target.closest('.arquivo-row');
                    if (row && !row.dataset.initial) {
                        row.remove();
                        updateVisibility();
                    }
                }
            });

            updateVisibility();
        })();
    </script>
</div>
{% endblock content %}